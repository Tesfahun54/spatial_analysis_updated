---
title: "Cross validation for the trials- for looping for factor without marker and without spatial
  analysis"
author: "Tesfahun A. Setotaw"
date: "2023-03-17"
output: html_document
---

```{r setup, setup}
knitr::opts_knit$set(root.dir = "/Users/tas286/Documents/Data_geno_pheno_for_selected_trials")
getwd()
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(root.dir = "/Users/tas286/Documents/Data_geno_pheno_for_selected_trials")
getwd()


```

## Introduction

This script is desinged to make cross validation analysis of the trials with marker and spatial information.

```{r cars}
# Load the packages necessary for the analysis
library(tidyverse)
library(sommer)
library(caret)
library(dplyr)
library(lme4)
#########################################
# Import phenotype data 
#######################################

setwd("/Users/tas286/Documents/Data_geno_pheno_for_selected_trials")
phen = read.csv("Phenotype_YldQt_Val_2014.csv" ) # replicated
head(phen)
## Change the factor variable to factor
set.seed(123)
phen$geno = as.factor(phen$germplasmName)
phen$rowf = as.factor(phen$rowNumber)
phen$colf = as.factor(phen$colNumber)
phen$col = phen$colNumber
phen$row = phen$rowNumber
phen$loc = as.factor(phen$locationName)
phen$Test_weight = phen$Grain.test.weight...g.l.CO_321.0001210
phen$Grain_Yield = phen$Grain.yield...kg.ha.CO_321.0001218
phen$Plant_height = phen$Plant.height...cm.CO_321.0001301

str(phen)
# colnames(phen)[37] = "Grain_protein"
# colnames(phen)[31] = "Test_weight"
# colnames(phen)[32] = "Grain_Yield"
# colnames(phen)[34] = "Plant_height"
#"Plant_height","Test_weight",
Traits = c( "Grain_Yield","Plant_height","Test_weight" )
dim(phen)
length(levels(phen$loc))

```


## Spliting the data as training and testing set and Analysis

In this section the data will be divided as training and testing set for the 5 fold cross validation. 

```{r pressure, echo=FALSE}
########################################33333#############
# Grouping the training and testing set for 5 fold validation
#  Preparing tibbles for output storage

pr_y = tibble()
# The tibble to store the Root Mean Squared Error (RMSQ)  and Mean Absolute Error (MAD)
Accu = tibble()
 # heritability estimate 
 H2_Trait = tibble()
 
phen$rep = as.factor(phen$replicate)
Env = levels(phen$loc)
dim(phen)

length(levels(phen$geno))

for(env in Env){
  SL <- droplevels(subset(x = phen, subset = loc == env)) # Subseting the data for each env
  TraitN = colnames(SL[Traits])[colSums(is.na(SL[Traits])) < 25] # selecting the trait 
  
  ntt = length((TraitN))
  head(SL)
  
for(Trait in TraitN){
   
#Choosing the method of outlier testing for replicated and unreplicated trials 
if(length(SL$rep)/length(levels(SL$geno)) <= 1){
     # removing outlier using boxplotstat for unreplicated trials 
out_ind <- which(SL[,paste(Trait)] %in% boxplot.stats(SL[,paste(Trait)])$out)

if(length(out_ind) == 0){
  SL = SL}else{
    
  SL = SL[-out_ind,]
}

}else{
    #removing outlier for replicated trials 
      eval(parse(text = paste("outl1 <- lmer(",Trait,"~(1|geno),
               data= SL)")))

      outlier = which(stats::rstudent(outl1) > 3)
      SL = SL[-outlier,]
}
  SL = droplevels(SL)
 
    eval(parse(text = paste("ans1 <- mmer(",Trait,"~1,
               random=~vsr(geno),
               rcov=~vsr(units),
               data= SL)")))
  r = length(levels(as.factor(SL$replicate)))
  ss = summary(ans1)
  vc = data.frame(ss$varcomp)
  
  rownames(vc) <- c("geno", "residual")
  h2 = cbind(location = paste(env),Trait = paste(Trait),
                heritability = round(vc["geno","VarComp"]/(vc["geno", "VarComp"] + (vc["residual", "VarComp"])/r),3))
    
  
  H2_Trait = rbind(H2_Trait,h2) # store the heritability in the tibble 


    ### Extract the effects of the factor variables in the model
    reff = randef(object = ans1)
    dim(reff$`u:geno`)
    reffd = data.frame(reff$`u:geno`) 
    dim(reffd)
    prd = reffd + as.vector(ans1$Beta["Estimate"]) # BLUPs of the genotypes 
    prd = as.data.frame(prd)
    obs = SL %>% group_by(geno) %>%
      summarise_at(.vars = paste(Trait), .funs = mean)
    obs = as.data.frame(obs)
    dim(obs)
    # Estimate the RMSE (Root mean square error) and MAE (mean absolute error) vlaues between the predicted and observed value
    RM = cbind(location = paste(env),Trait = paste(Trait),RMSE = round(RMSE(prd[,paste(Trait)], as.vector(obs[,paste(Trait)]), na.rm = T),3),
               MAE = round(MAE(prd[,paste(Trait)], obs[,paste(Trait)], na.rm = T),3))
    # Estimate the predictability among the estiamted and predicted value
    preid = cbind(location = paste(env),Trait = paste(Trait),
                  predictability = round(cor(prd[,paste(Trait)],
                                             obs[,paste(Trait)],
                                             use = "pairwise.complete.obs"),3)) # estimate the correlation of the obseved and the predicted value

    Accu = rbind(Accu,RM) # store the measure of accuracy in tibble
    pr_y = rbind(pr_y,preid) # store model predictability in tibble

}
}
  

```

#Write the output in excel
```{r}
out = list(Accuracy = Accu, Predictability = pr_y, Heritability = H2_Trait)

library(openxlsx)
write.xlsx(x = out, file = "outputs_March2021/Result_with_marker_and_without_spatial_Analysis_YldQt_Val_2014.xlsx")

mean(as.numeric(pr_y$predictability), na.rm = T)


```

```{r}
########################################################################################
# Plot the outputs 
#########################################################################################
library(ggplot2)
library(readxl)
predictrep <- read_excel("outputs_March2021/Result_with_marker_and_spatial_Analysis_sommer_un_replicated_subset_by_loc.xlsx", 
sheet = "Predictability")
predictwo <- read_excel("outputs_March2021/Result_with_marker_and_without_spatial_Analysis_YldQt_Val_2014.xlsx", 
sheet = "Predictability")


predictrep$predictability = as.numeric(predictrep$predictability)
predictrep$rep = "replicated"
predictrep$spatial = "With Spatial"
predictwo$predictability = as.numeric(predictwo$predictability)
predictwo$rep = "unreplicated"
predictwo$spatial = "Without Spatial"
# combine the data 
predsp = rbind(predictrep,predictwo)
predsp$rep = as.factor(predsp$rep)
predsp$spatial 



ggplot(predictwo) + 
  geom_boxplot(aes(x= Trait, y=predictability, fill= Trait))+
  theme_bw() + facet_grid(~spatial)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Predictability with marker and with/out spatial analysis_unreplicated_by_loc")
 

```

